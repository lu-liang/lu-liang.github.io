<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="lu liang 在Github上的个人博客">
    <meta name="keyword" content="AI, Cloud">
    <meta name="theme-color" content="#600090">
    <meta name="msapplication-navbutton-color" content="#600090">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="#600090">
    <link rel="shortcut icon" href="https://cdn4.iconfinder.com/data/icons/ionicons/512/icon-person-128.png">
    <link rel="alternate" type="application/atom+xml" title="亮随笔" href="/atom.xml">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.css">
    <title>
        
        Play with minikube, helm, metallb and istio｜Liang&#39;s blog
        
    </title>

    <link rel="canonical" href="http://lu-liang.github.io/2018/11/05/play-with-minikube/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="../../../../css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../../../../css/blog-style.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="../../../../css/syntax.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<style>

    header.intro-header {
        background-image: url('//o7bkkhiex.bkt.clouddn.com/lion-blur-bg.jpg')
    }
</style>
<!-- hack iOS CSS :active style -->
<body ontouchstart="" class="animated fadeIn">
<!-- hexo-inject:begin --><!-- hexo-inject:end --><!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top " id="nav-top" data-ispost = "true" data-istags="false
" data-ishome = "false" >
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand animated pulse" href="/">
                <span class="brand-logo">
                    亮随笔
                </span>
                's Blog
            </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <!-- /.navbar-collapse -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
					
                    
                        
							
                        <li>
                            <a href="/Tags/">Tags</a>
                        </li>
							
						
                    
					
					
                </ul>
            </div>
        </div>
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
//    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>

<!-- Main Content -->

<!--only post-->


<img class="wechat-title-img"
     src="">


<style>
    
    header.intro-header {
        background-image: url('')
    }

    
</style>

<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <div class="post-heading">
                    <h1>Play with minikube, helm, metallb and istio</h1>
                    
                    <span class="meta">
                         作者 Lu Liang
                        <span>
                          日期 2018-11-05
                         </span>
                    </span>
                    <div class="tags text-center">
                        
                        <a class="tag" href="/tags/#minikube"
                           title="minikube">minikube</a>
                        
                        <a class="tag" href="/tags/#kubernetes"
                           title="kubernetes">kubernetes</a>
                        
                        <a class="tag" href="/tags/#helm"
                           title="helm">helm</a>
                        
                        <a class="tag" href="/tags/#Istio"
                           title="Istio">Istio</a>
                        
                        <a class="tag" href="/tags/#Metallb"
                           title="Metallb">Metallb</a>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="post-title-haojen">
        <span>
            Play with minikube, helm, metallb and istio
        </span>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Container -->
            <div class="col-lg-8 col-lg-offset-1 col-sm-9 post-container">
                <p>kubernetes是容器世界的主要编排工具。熟悉并掌握kubernetes上的相关技能，在当前云计算领域是必不可少的。本文主要介绍一下如何在mac上安装minikube，并尝试使用helm，metallb及Istio.</p>
<h2 id="virtual-environment"><a href="#virtual-environment" class="headerlink" title="virtual environment"></a>virtual environment</h2><p>minikube可以支持使用多种虚拟机驱动器，例如：xhyve、VirtualBox、VMwareFusion、hyperV、KVM等。在这里，我们使用virtualBox 去运行虚拟的minikube实例。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew cask install virtual box</span><br><span class="line"></span><br><span class="line">## reinstall virtualbox with debug info</span><br><span class="line">## brew cask reinstall --force virtualbox --verbose --debug</span><br></pre></td></tr></table></figure>
<p>使用brew安装virtualBox的过程中，有可能会遇到与kernel driver相关的错误，通过修改下面的Mac系统设置，再重新安装就能解决。</p>
<img src="/2018/11/05/play-with-minikube/mac_os_setting.png" title="mac_os_setting.png">
<h2 id="minikube"><a href="#minikube" class="headerlink" title="minikube"></a>minikube</h2><ol>
<li>install minikube<br>和上面安装virtualBox一样，在Mac上，最简单的安装方式就是使用brew去安装minikube.</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># install minikube</span><br><span class="line">brew cask install minikube</span><br></pre></td></tr></table></figure>
<p>minikube is a kind of one node kubernetes cluster which is installed in one virtual machine. After installing minikube, when you open the virutalbox, you will find the “minikube” vm. At the same time, it also installs “kubectl” command at your mac laptop.</p>
<img src="/2018/11/05/play-with-minikube/virtualbox_minikube.png" title="virtualbox_minikube.png">
<p>This is the architecture of minikube.</p>
<img src="/2018/11/05/play-with-minikube/minikube_arch.png" title="minikube_arch.png">
<p>minikube will install everything on the default folder $HOME/.minikube. You can go to the folder and then dig into the details.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜  .minikube pwd</span><br><span class="line">/Users/luliang/.minikube</span><br><span class="line">➜  .minikube ls</span><br><span class="line">addons              ca.pem              client.key          machines            proxy-client.key</span><br><span class="line">apiserver.crt       cache               config              profiles</span><br><span class="line">apiserver.key       cert.pem            files               proxy-client-ca.crt</span><br><span class="line">ca.crt              certs               key.pem             proxy-client-ca.key</span><br><span class="line">ca.key              client.crt          logs                proxy-client.crt</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>minikube start<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## start minikube</span><br><span class="line">minikube start</span><br><span class="line"></span><br><span class="line">## show status</span><br><span class="line">➜ minikube status</span><br><span class="line">minikube: Running</span><br><span class="line">cluster: Running</span><br><span class="line">kubectl: Correctly Configured: pointing to minikube-vm at 192.168.99.100</span><br><span class="line"></span><br><span class="line">➜ kubectl config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority: /Users/luliang/.minikube/ca.crt</span><br><span class="line">    server: https://192.168.99.100:8443</span><br><span class="line">  name: minikube</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: minikube</span><br><span class="line">    user: minikube</span><br><span class="line">  name: minikube</span><br><span class="line">current-context: minikube</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: minikube</span><br><span class="line">  user:</span><br><span class="line">    client-certificate: /Users/luliang/.minikube/client.crt</span><br><span class="line">    client-key: /Users/luliang/.minikube/client.key</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>If you encountered the following error during starting minikube, you can try to fix it with the solution below.</p>
<blockquote>
<p><strong>Error Message:</strong><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜  ~ minikube start</span><br><span class="line">Starting local Kubernetes v1.10.0 cluster...</span><br><span class="line">Starting VM...</span><br><span class="line">Getting VM IP address...</span><br><span class="line">Moving files into cluster...</span><br><span class="line">Setting up certs...</span><br><span class="line">Connecting to cluster...</span><br><span class="line">Setting up kubeconfig...</span><br><span class="line">Starting cluster components...</span><br><span class="line">E0912 17:39:12.486830   17689 start.go:305] Error restarting</span><br><span class="line">cluster:  restarting kube-proxy: waiting for kube-proxy to be</span><br><span class="line">up for configmap update: timed out waiting for the condition</span><br><span class="line"></span><br><span class="line">➜  ~ kubectl -n kube-system get pods</span><br><span class="line">NAME                                    READY     STATUS             RESTARTS   AGE</span><br><span class="line">coredns-c4cffd6dc-5q6n2                 0/1       CrashLoopBackOff   69         5h</span><br><span class="line">etcd-minikube                           1/1       Running            0          4h</span><br><span class="line">kube-addon-manager-minikube             1/1       Running            1          4h</span><br><span class="line">kube-apiserver-minikube                 1/1       Running            0          4h</span><br><span class="line">kube-controller-manager-minikube        1/1       Running            0          4h</span><br><span class="line">kube-scheduler-minikube                 1/1       Running            1          4h</span><br><span class="line">kubernetes-dashboard-6f4cfc5d87-45dr8   0/1       CrashLoopBackOff   65         5h</span><br><span class="line">storage-provisioner                     0/1       CrashLoopBackOff   65         5h</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p><strong>Solution:</strong><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1) close the VirtualBox if opened.</span><br><span class="line">2) delete the previous temp files generated.</span><br><span class="line">3) if you are behind the proxy set the proxy.</span><br><span class="line">4) then do the following...</span><br><span class="line"></span><br><span class="line">    $ minikube stop</span><br><span class="line">    $ minikube delete</span><br><span class="line">    $ minikube start</span><br></pre></td></tr></table></figure></p>
</blockquote>
<ol start="3">
<li><p>deploy hello-world in minikube<br>安装完minikube以后，我们可以在minikube里部署一个hello-world来验证功能。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## There is no pod before deploying hello-world.</span><br><span class="line">➜  ~ kubectl get pods</span><br><span class="line">No resources found.</span><br><span class="line"></span><br><span class="line">➜  ~ kubectl get ns</span><br><span class="line">NAME          STATUS    AGE</span><br><span class="line">default       Active    6m</span><br><span class="line">kube-public   Active    6m</span><br><span class="line">kube-system   Active    6m</span><br><span class="line"></span><br><span class="line">## run hello-world.</span><br><span class="line">➜  ~ kubectl run hello-minikube --image=k8s.gcr.io/echoserver:1.4 --port=8080</span><br><span class="line">deployment.apps/hello-minikube created</span><br><span class="line"></span><br><span class="line">## check pod of hello-world</span><br><span class="line">➜  ~ kubectl get po</span><br><span class="line">NAME                             READY     STATUS              RESTARTS   AGE</span><br><span class="line">hello-minikube-6c47c66d8-jks94   0/1       ContainerCreating   0          6s</span><br><span class="line"></span><br><span class="line">## expose its service as NodePort since there is no external load balancer in minikube.</span><br><span class="line">➜  ~ kubectl expose deployment hello-minikube --type=NodePort</span><br><span class="line">service/hello-minikube exposed</span><br><span class="line"></span><br><span class="line">## get the details of the service.</span><br><span class="line">➜  ~ kubectl get svc</span><br><span class="line">NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">hello-minikube   NodePort    10.98.53.207   &lt;none&gt;        8080:31251/TCP   1m</span><br><span class="line">kubernetes       ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP          16m</span><br><span class="line"></span><br><span class="line">## verify it by curl</span><br><span class="line">➜  ~ curl $(minikube service hello-minikube --url)</span><br><span class="line">CLIENT VALUES:</span><br><span class="line">client_address=172.17.0.1</span><br><span class="line">command=GET</span><br><span class="line">real path=/</span><br><span class="line">query=nil</span><br><span class="line">request_version=1.1</span><br><span class="line">request_uri=http://192.168.99.100:8080/</span><br><span class="line"></span><br><span class="line">SERVER VALUES:</span><br><span class="line">server_version=nginx: 1.10.0 - lua: 10001</span><br><span class="line"></span><br><span class="line">HEADERS RECEIVED:</span><br><span class="line">accept=*/*</span><br><span class="line">host=192.168.99.100:31251</span><br><span class="line">user-agent=curl/7.52.1</span><br><span class="line">BODY:</span><br><span class="line">-no body in request-%</span><br></pre></td></tr></table></figure>
</li>
<li><p>minikube addons<br>minikube 里有以下的addons，可以通过 <strong>minikube addons enable</strong> 命令直接启用。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜  ~ minikube addons list</span><br><span class="line">- addon-manager: enabled</span><br><span class="line">- coredns: enabled</span><br><span class="line">- dashboard: enabled</span><br><span class="line">- default-storageclass: enabled</span><br><span class="line">- efk: disabled</span><br><span class="line">- freshpod: disabled</span><br><span class="line">- heapster: disabled</span><br><span class="line">- ingress: disabled</span><br><span class="line">- kube-dns: disabled</span><br><span class="line">- metrics-server: disabled</span><br><span class="line">- nvidia-driver-installer: disabled</span><br><span class="line">- nvidia-gpu-device-plugin: disabled</span><br><span class="line">- registry: disabled</span><br><span class="line">- registry-creds: disabled</span><br><span class="line">- storage-provisioner: enabled</span><br><span class="line"></span><br><span class="line">➜  ~ minikube addons enable metrics-server</span><br><span class="line">metrics-server was successfully enabled</span><br></pre></td></tr></table></figure>
</li>
<li><p>start dashboard</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜  ~ minikube dashboard</span><br><span class="line">Opening http://127.0.0.1:61035/api/v1/namespaces/kube-system/services/http:kubernetes-dashboard:/proxy/ in your default browser...</span><br></pre></td></tr></table></figure>
</li>
</ol>
<img src="/2018/11/05/play-with-minikube/minikube_dashboard.png" title="minikube_dashboard.png">
<ol start="6">
<li>minikube ssh<br>we can login the vm of minikube to look into details or operate it.<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">minikube ssh</span><br><span class="line">➜  istio-1.1.0-snapshot.2 minikube ssh</span><br><span class="line">                         _             _</span><br><span class="line">            _         _ ( )           ( )</span><br><span class="line">  ___ ___  (_)  ___  (_)| |/&apos;)  _   _ | |_      __</span><br><span class="line">/&apos; _ ` _ `\| |/&apos; _ `\| || , &lt;  ( ) ( )| &apos;_`\  /&apos;__`\</span><br><span class="line">| ( ) ( ) || || ( ) || || |\`\ | (_) || |_) )(  ___/</span><br><span class="line">(_) (_) (_)(_)(_) (_)(_)(_) (_)`\___/&apos;(_,__/&apos;`\____)</span><br><span class="line"></span><br><span class="line">$</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="Helm"><a href="#Helm" class="headerlink" title="Helm"></a>Helm</h2><p>Helm is a kind of application package manager in kubernetes platform. It can be used to list/install/update/delete application easily.</p>
<p>Helm consists of client “helm” and server “tiller” installed on kubernetes. The following chart is the architecture of helm.<br><img src="/2018/11/05/play-with-minikube/helm_arch.png" title="helm_arch.png"></p>
<ol>
<li><p>install helm<br>Like minikube, helm is also installed on $HOME/.helm.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew install kubernetes-helm</span><br><span class="line"></span><br><span class="line">➜  .helm pwd</span><br><span class="line">/Users/luliang/.helm</span><br><span class="line">➜  .helm ls</span><br><span class="line">cache      plugins    repository starters</span><br></pre></td></tr></table></figure>
</li>
<li><p>initialize helm and install tiller on minikube</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## check if RBAC is enable.</span><br><span class="line">➜ kubectl api-versions |grep rbac</span><br><span class="line">rbac.authorization.k8s.io/v1</span><br><span class="line">rbac.authorization.k8s.io/v1beta1</span><br><span class="line">rbac.istio.io/v1alpha1</span><br><span class="line"></span><br><span class="line">## create user and role if The RBAC of kubernetes is enabled.</span><br><span class="line"></span><br><span class="line">➜ kubectl apply -f install/kubernetes/helm/helm-service-account.yaml</span><br><span class="line">serviceaccount/tiller created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/tiller created</span><br><span class="line"></span><br><span class="line">➜ helm init --service-account tiller</span><br><span class="line"></span><br><span class="line">## if it&apos;s disabled.</span><br><span class="line">➜ helm init</span><br><span class="line">Creating /Users/luliang/.helm</span><br><span class="line">Creating /Users/luliang/.helm/repository</span><br><span class="line">Creating /Users/luliang/.helm/repository/cache</span><br><span class="line">Creating /Users/luliang/.helm/repository/local</span><br><span class="line">Creating /Users/luliang/.helm/plugins</span><br><span class="line">Creating /Users/luliang/.helm/starters</span><br><span class="line">Creating /Users/luliang/.helm/cache/archive</span><br><span class="line">Creating /Users/luliang/.helm/repository/repositories.yaml</span><br><span class="line">Adding stable repo with URL: https://kubernetes-charts.storage.googleapis.com</span><br><span class="line">Adding local repo with URL: http://127.0.0.1:8879/charts</span><br><span class="line">$HELM_HOME has been configured at /Users/luliang/.helm.</span><br><span class="line"></span><br><span class="line">Tiller (the Helm server-side component) has been installed into your Kubernetes Cluster.</span><br><span class="line"></span><br><span class="line">Please note: by default, Tiller is deployed with an insecure &apos;allow unauthenticated users&apos; policy.</span><br><span class="line">For more information on securing your installation see: https://docs.helm.sh/using_helm/#securing-your-helm-installation</span><br><span class="line">Happy Helming!</span><br><span class="line"></span><br><span class="line">## list po to check tiller is installed into the cluster</span><br><span class="line">➜ kubectl get po -n kube-system</span><br><span class="line">NAME                                    READY     STATUS    RESTARTS   AGE</span><br><span class="line">coredns-c4cffd6dc-cbqw9                 1/1       Running   1          1d</span><br><span class="line">etcd-minikube                           1/1       Running   0          41m</span><br><span class="line">kube-addon-manager-minikube             1/1       Running   1          1d</span><br><span class="line">kube-apiserver-minikube                 1/1       Running   0          41m</span><br><span class="line">kube-controller-manager-minikube        1/1       Running   0          41m</span><br><span class="line">kube-dns-86f4d74b45-t44f6               3/3       Running   3          1d</span><br><span class="line">kube-proxy-5scqj                        1/1       Running   0          40m</span><br><span class="line">kube-scheduler-minikube                 1/1       Running   1          1d</span><br><span class="line">kubernetes-dashboard-6f4cfc5d87-jb5rx   1/1       Running   3          1d</span><br><span class="line">metrics-server-85c979995f-n5hdx         1/1       Running   2          1d</span><br><span class="line">storage-provisioner                     1/1       Running   3          1d</span><br><span class="line">tiller-deploy-f9b8476d-b4ws9            1/1       Running   0          2m</span><br></pre></td></tr></table></figure>
</li>
<li><p>update the repo of helm and then install jenkins</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜ helm repo update</span><br><span class="line">Hang tight while we grab the latest from your chart repositories...</span><br><span class="line">...Skip local chart repository</span><br><span class="line">...Successfully got an update from the &quot;stable&quot; chart repository</span><br><span class="line">Update Complete. ⎈ Happy Helming!⎈</span><br><span class="line"></span><br><span class="line">➜ helm search jenkins</span><br><span class="line">NAME          	CHART VERSION	APP VERSION	DESCRIPTION</span><br><span class="line">stable/jenkins	0.21.0       	lts        	Open source continuous integration server. It s...</span><br><span class="line"></span><br><span class="line">➜ helm install stable/jenkins</span><br><span class="line">NAME:   exegetical-manatee</span><br><span class="line">LAST DEPLOYED: Tue Nov  6 20:13:58 2018</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: DEPLOYED</span><br><span class="line"></span><br><span class="line">RESOURCES:</span><br><span class="line">==&gt; v1/Service</span><br><span class="line">NAME                              TYPE          CLUSTER-IP      EXTERNAL-IP  PORT(S)         AGE</span><br><span class="line">exegetical-manatee-jenkins-agent  ClusterIP     10.100.233.152  &lt;none&gt;       50000/TCP       0s</span><br><span class="line">exegetical-manatee-jenkins        LoadBalancer  10.99.251.83    &lt;pending&gt;    8080:31993/TCP  0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Deployment</span><br><span class="line">NAME                        DESIRED  CURRENT  UP-TO-DATE  AVAILABLE  AGE</span><br><span class="line">exegetical-manatee-jenkins  1        1        1           0          0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Pod(related)</span><br><span class="line">NAME                                        READY  STATUS   RESTARTS  AGE</span><br><span class="line">exegetical-manatee-jenkins-dc7bb4fff-qrkq4  0/1    Pending  0         0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Secret</span><br><span class="line">NAME                        TYPE    DATA  AGE</span><br><span class="line">exegetical-manatee-jenkins  Opaque  2     0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/ConfigMap</span><br><span class="line">NAME                              DATA  AGE</span><br><span class="line">exegetical-manatee-jenkins        5     0s</span><br><span class="line">exegetical-manatee-jenkins-tests  1     0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/PersistentVolumeClaim</span><br><span class="line">NAME                        STATUS  VOLUME                                    CAPACITY  ACCESS MODES  STORAGECLASS  AGE</span><br><span class="line">exegetical-manatee-jenkins  Bound   pvc-70b3ad8a-e1bd-11e8-b9ce-0800277f5208  8Gi       RWO           standard      0s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NOTES:</span><br><span class="line">1. Get your &apos;admin&apos; user password by running:</span><br><span class="line">  printf $(kubectl get secret --namespace default exegetical-manatee-jenkins -o jsonpath=&quot;&#123;.data.jenkins-admin-password&#125;&quot; | base64 --decode);echo</span><br><span class="line">2. Get the Jenkins URL to visit by running these commands in the same shell:</span><br><span class="line">  NOTE: It may take a few minutes for the LoadBalancer IP to be available.</span><br><span class="line">        You can watch the status of by running &apos;kubectl get svc --namespace default -w exegetical-manatee-jenkins&apos;</span><br><span class="line">  export SERVICE_IP=$(kubectl get svc --namespace default exegetical-manatee-jenkins --template &quot;&#123;&#123; range (index .status.loadBalancer.ingress 0) &#125;&#125;&#123;&#123; . &#125;&#125;&#123;&#123; end &#125;&#125;&quot;)</span><br><span class="line">  echo http://$SERVICE_IP:8080/login</span><br><span class="line"></span><br><span class="line">3. Login with the password from step 1 and the username: admin</span><br><span class="line"></span><br><span class="line">For more information on running Jenkins on Kubernetes, visit:</span><br><span class="line">https://cloud.google.com/solutions/jenkins-on-container-engine</span><br></pre></td></tr></table></figure>
</li>
<li><p>verify the jenkins.<br>In order to access to the jenkins service, we have to change the jenkins services from “LoadBalancer” to “NodePort” since we don’t have an external loadbalancer yet.  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜ kubectl get svc --namespace default -w exegetical-manatee-jenkins</span><br><span class="line">NAME                         TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">exegetical-manatee-jenkins   LoadBalancer   10.99.251.83   &lt;pending&gt;     8080:31993/TCP   2m</span><br><span class="line">^C%         </span><br><span class="line"></span><br><span class="line">➜ kubectl edit svc exegetical-manatee-jenkins</span><br><span class="line">service/exegetical-manatee-jenkins edited</span><br><span class="line"></span><br><span class="line">➜ kubectl get svc --namespace default -w exegetical-manatee-jenkins</span><br><span class="line">NAME                         TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">exegetical-manatee-jenkins   NodePort   10.99.251.83   &lt;none&gt;        8080:31993/TCP   5m</span><br><span class="line"></span><br><span class="line">## we also can get the service info by minikube command.</span><br><span class="line">➜ minikube service list</span><br><span class="line">|-------------|----------------------------------|-----------------------------|</span><br><span class="line">|  NAMESPACE  |               NAME               |             URL             |</span><br><span class="line">|-------------|----------------------------------|-----------------------------|</span><br><span class="line">| default     | exegetical-manatee-jenkins       | http://192.168.99.100:31993 |</span><br><span class="line">| default     | exegetical-manatee-jenkins-agent | No node port                |</span><br><span class="line">| default     | hello-minikube                   | http://192.168.99.100:31251 |</span><br><span class="line">| default     | kubernetes                       | No node port                |</span><br><span class="line">| default     | my-nginx                         | http://192.168.99.100:32370 |</span><br><span class="line">| kube-system | kube-dns                         | No node port                |</span><br><span class="line">| kube-system | kubernetes-dashboard             | No node port                |</span><br><span class="line">| kube-system | metrics-server                   | No node port                |</span><br><span class="line">| kube-system | tiller-deploy                    | No node port                |</span><br><span class="line">|-------------|----------------------------------|-----------------------------|</span><br></pre></td></tr></table></figure>
</li>
</ol>
<img src="/2018/11/05/play-with-minikube/helm_jenkins.png" title="helm_jenkins.png">
<h2 id="Metallb"><a href="#Metallb" class="headerlink" title="Metallb"></a>Metallb</h2><p>Metallb is a new project, open-sourced by Google end of 2017. Its goal is to manage external IPs on k8s bare-metal deployments.</p>
<p>After installing Metalib, there are one deployment and one daemonset in cluster.</p>
<ul>
<li>The metallb-system/controller deployment. This is the cluster-wide controller that handles IP address assignments.</li>
<li>The metallb-system/speaker daemonset. This is the component that speaks the protocol(s) of your choice to make the services reachable.</li>
</ul>
<h3 id="install-Metallb-with-helm"><a href="#install-Metallb-with-helm" class="headerlink" title="install Metallb with helm."></a>install Metallb with helm.</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## The config is not managed by helm.</span><br><span class="line">➜ helm install --name metallb stable/metallb</span><br><span class="line"></span><br><span class="line">## the two pods of metallb are deployed.</span><br><span class="line">➜ kubectl get po</span><br><span class="line">NAME                                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">metallb-controller-5d4c5548f7-t2qfd   1/1     Running   0          2m</span><br><span class="line">metallb-speaker-27dd8                 1/1     Running   0          2m</span><br><span class="line"></span><br><span class="line">## install jenkins by helm</span><br><span class="line">➜ helm install --name jenkins stable/jenkins</span><br><span class="line"></span><br><span class="line">## the ip of jenkins service is still pending since there is no config for metallb.</span><br><span class="line">➜ kubectl get svc</span><br><span class="line">NAME            TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">jenkins         LoadBalancer   10.104.220.135   &lt;pending&gt;     8080:31249/TCP   4m</span><br><span class="line">jenkins-agent   ClusterIP      10.107.222.223   &lt;none&gt;        50000/TCP        4m</span><br><span class="line">kubernetes      ClusterIP      10.96.0.1        &lt;none&gt;        443/TCP          1d</span><br><span class="line"></span><br><span class="line">## create the config of metallb. Update the ip config based on the settings of DHCP server.</span><br><span class="line">➜ more config-metallb.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  namespace: default</span><br><span class="line">  name: metallb-config</span><br><span class="line">data:</span><br><span class="line">  config: |</span><br><span class="line">    address-pools:</span><br><span class="line">    - name: default</span><br><span class="line">      protocol: layer2</span><br><span class="line">      addresses:</span><br><span class="line">      - 192.168.99.200-192.168.99.250</span><br><span class="line"></span><br><span class="line">➜ kubectl apply -f config-metallb.yml</span><br><span class="line">configmap/metallb-config created</span><br><span class="line"></span><br><span class="line">## external ip is assigned by metallb.</span><br><span class="line">➜ kubectl get svc</span><br><span class="line">NAME            TYPE           CLUSTER-IP       EXTERNAL-IP      PORT(S)          AGE</span><br><span class="line">jenkins         LoadBalancer   10.104.220.135   192.168.99.200   8080:31249/TCP   5m</span><br><span class="line">jenkins-agent   ClusterIP      10.107.222.223   &lt;none&gt;           50000/TCP        5m</span><br><span class="line">kubernetes      ClusterIP      10.96.0.1        &lt;none&gt;           443/TCP          1d</span><br></pre></td></tr></table></figure>
<img src="/2018/11/05/play-with-minikube/virtualbox_minikube_ip_arrange.png" title="virtualbox_minikube_ip_arrange.png">
<p>We can verify the jenkins by external ip.<br><img src="/2018/11/05/play-with-minikube/helm_jenkins_external_ip.png" title="helm_jenkins_external_ip.png"></p>
<h3 id="install-Metallb-without-helm"><a href="#install-Metallb-without-helm" class="headerlink" title="install Metallb without helm"></a>install Metallb without helm</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## install Metallb without helm. ##</span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/google/metallb/v0.2.1/manifests/metallb.yaml</span><br><span class="line"></span><br><span class="line">kubectl get po -n metallb-system</span><br><span class="line"></span><br><span class="line">(on your host) $ cat &lt;&lt;EOF &gt; config-metallb.yml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  namespace: metallb-system</span><br><span class="line">  name: config</span><br><span class="line">data:</span><br><span class="line">  config: |</span><br><span class="line">    address-pools:</span><br><span class="line">    - name: default</span><br><span class="line">      protocol: layer2</span><br><span class="line">      addresses:</span><br><span class="line">      - 192.168.99.240-192.168.99.250      </span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl create -f config-metallb.yml</span><br><span class="line"></span><br><span class="line">## verify Metallb with nginx</span><br><span class="line">kubectl expose deployment nginx --type LoadBalancer</span><br><span class="line"></span><br><span class="line">kubectl get svc nginx</span><br></pre></td></tr></table></figure>
<h2 id="Istio"><a href="#Istio" class="headerlink" title="Istio"></a>Istio</h2><ol>
<li><p>Download and setup Istio</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -L https://git.io/getLatestIstio | sh -</span><br><span class="line"></span><br><span class="line"># or download the release and uncompress it by yourself.</span><br><span class="line">wget https://github.com/istio/istio/releases/download/1.1.0-snapshot.2/istio-1.1.0-snapshot.2-osx.tar.gz</span><br><span class="line"></span><br><span class="line">tar -xvzf istio*.tar.gz</span><br><span class="line"></span><br><span class="line">#setup path for istio.</span><br><span class="line">export PATH=/Users/luliang/Tools/istio/istio-1.1.0-snapshot.2/bin:$PATH</span><br></pre></td></tr></table></figure>
</li>
<li><p>Install and verify Istio<br>Istio can be installed by kubectl or helm. Here, we will introduce how to use helm to install Istio. By the way, if the version of helm is prior to 2.10, Please create CRDs with kubectl firstly.</p>
</li>
</ol>
<ul>
<li><p>prerequisites</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜ kubectl apply -f install/kubernetes/helm/istio/templates/crds.yaml</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/virtualservices.networking.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/destinationrules.networking.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/serviceentries.networking.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/gateways.networking.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/envoyfilters.networking.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/clusterrbacconfigs.rbac.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/policies.authentication.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/meshpolicies.authentication.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/httpapispecbindings.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/httpapispecs.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/quotaspecbindings.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/quotaspecs.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/rules.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/attributemanifests.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/bypasses.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/circonuses.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/deniers.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/fluentds.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/kubernetesenvs.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/listcheckers.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/memquotas.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/noops.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/opas.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/prometheuses.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/rbacs.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/redisquotas.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/servicecontrols.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/signalfxs.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/solarwindses.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/stackdrivers.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/statsds.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/stdios.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/apikeys.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/authorizations.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/checknothings.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/kuberneteses.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/listentries.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/logentries.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/edges.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/metrics.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/quotas.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/reportnothings.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/servicecontrolreports.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/tracespans.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/rbacconfigs.rbac.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/serviceroles.rbac.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/servicerolebindings.rbac.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/adapters.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/instances.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/templates.config.istio.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/handlers.config.istio.io created</span><br><span class="line"></span><br><span class="line">➜ kubectl apply -f install/kubernetes/helm/subcharts/certmanager/templates/crds.yaml</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/clusterissuers.certmanager.k8s.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/issuers.certmanager.k8s.io created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/certificates.certmanager.k8s.io created</span><br></pre></td></tr></table></figure>
</li>
<li><p>install command:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">helm install install/kubernetes/helm/istio --name istio --namespace istio-system</span><br><span class="line"></span><br><span class="line">## if we don&apos;t install metallb and there is no external loadbalancer. We have to use the following command to install istio.</span><br><span class="line"></span><br><span class="line">helm install install/kubernetes/helm/istio --name istio --namespace istio-system --set gateways.istio-ingressgateway.type=NodePort --set gateways.istio-egressgateway.type=NodePort</span><br></pre></td></tr></table></figure>
</li>
<li><p>issues during installation<br>If you encounter the following errors, you can fix it with the solution described below.</p>
</li>
</ul>
<p><strong>issue 1</strong></p>
<blockquote>
<p><strong>Error Message:</strong><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜ helm install install/kubernetes/helm/istio --name istio --namespace istio-system</span><br><span class="line">Error: found in requirements.yaml, but missing in charts/ directory: sidecarInjectorWebhook, security, ingress, gateways, mixer, nodeagent, pilot, grafana, prometheus, servicegraph, tracing, galley, kiali, certmanager</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p><strong>Solution:</strong><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">helm dep update install/kubernetes/helm/istio</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p><strong>issue 2</strong></p>
<blockquote>
<p><strong>Error Message:</strong><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜ helm install install/kubernetes/helm/istio --name istio --namespace istio-system</span><br><span class="line"></span><br><span class="line">Error: transport is closing</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p><strong>Solution:</strong><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## enable port-forwarding in node.</span><br><span class="line">run &apos;yum install -y socat&apos; on every node can resolve this problem.</span><br><span class="line"></span><br><span class="line">## When call helm, try to use --wait --timeout 600 and --tiller-connection-timeout 600 to fix the problem.</span><br><span class="line">helm install install/kubernetes/helm/istio --name istio --namespace istio-system  --wait --timeout 600 --tiller-connection-timeout 600</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p><strong>issue 3</strong></p>
<blockquote>
<p><strong>Error Message:</strong><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## check istio version</span><br><span class="line">➜  istioctl version</span><br><span class="line">version.BuildInfo&#123;Version:&quot;1.1.0-snapshot.2&quot;, GitRevision:&quot;bd24a62648c07e24ca655c39727aeb0e4761919a&quot;, User:&quot;root&quot;, Host:&quot;6408abaf1dac&quot;, GolangVersion:&quot;go1.10.4&quot;, DockerHub:&quot;docker.io/istio&quot;, BuildStatus:&quot;Clean&quot;&#125;</span><br><span class="line"></span><br><span class="line">## check the status of istio</span><br><span class="line">➜ kubectl get po -n istio-system</span><br><span class="line">NAME                                      READY   STATUS      RESTARTS   AGE</span><br><span class="line">istio-citadel-78f695c895-bgm9c            1/1     Running     3          13h</span><br><span class="line">istio-egressgateway-5dddcd6df7-f5shm      1/1     Running     3          13h</span><br><span class="line">istio-galley-85fff4bf65-hd7l2             1/1     Running     3          13h</span><br><span class="line">istio-ingressgateway-6d5bc988d7-gmvg2     1/1     Running     3          13h</span><br><span class="line">istio-pilot-5fdf6bdb86-rgq4f              0/2     Pending     0          13h</span><br><span class="line">istio-policy-59df9cf56f-vbznd             2/2     Running     19         13h</span><br><span class="line">istio-security-post-install-pkrtj         0/1     Completed   0          13h</span><br><span class="line">istio-sidecar-injector-5695fdf5b7-lgdbn   1/1     Running     12         13h</span><br><span class="line">istio-telemetry-7d567f4998-7btv8          2/2     Running     24         13h</span><br><span class="line">prometheus-7fcd5846db-8t9v2               1/1     Running     10         13h</span><br><span class="line"></span><br><span class="line">## pilot is still pending, check it and find it&apos;s insufficient memory issue.</span><br><span class="line">➜ kubectl describe po  -n istio-system istio-pilot-5fdf6bdb86-rgq4f</span><br><span class="line"></span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age                    From               Message</span><br><span class="line">  ----     ------            ----                   ----               -------</span><br><span class="line">  Warning  FailedScheduling  13h (x37 over 13h)     default-scheduler  0/1 nodes are available: 1 Insufficient memory.</span><br><span class="line">  Warning  FailedScheduling  12h (x36 over 13h)     default-scheduler  0/1 nodes are available: 1 Insufficient memory.</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p><strong>Solution:</strong></p>
<ol>
<li>increase the memory of minikube to 4G by modifying the config.json<br>Another way is to start minikube with –memory parameter<br>   “minikube start –memory 4096”</li>
<li>Edit the deployment of istio-pilot to decrease memory to 1G.</li>
</ol>
</blockquote>
<img src="/2018/11/05/play-with-minikube/istio_pilot_mem.png" title="istio_pilot_mem.png">
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## increase the memory of minikube to 4G by modifying the config.json</span><br><span class="line">➜ minikube stop</span><br><span class="line"></span><br><span class="line">➜  minikube pwd</span><br><span class="line">  /Users/luliang/.minikube/machines/minikube</span><br><span class="line">➜  minikube more config.json</span><br><span class="line">  &#123;</span><br><span class="line">      &quot;ConfigVersion&quot;: 3,</span><br><span class="line">      &quot;Driver&quot;: &#123;</span><br><span class="line">          &quot;IPAddress&quot;: &quot;192.168.99.100&quot;,</span><br><span class="line">          &quot;MachineName&quot;: &quot;minikube&quot;,</span><br><span class="line">          &quot;SSHUser&quot;: &quot;docker&quot;,</span><br><span class="line">          &quot;SSHPort&quot;: 56365,</span><br><span class="line">          &quot;SSHKeyPath&quot;: &quot;/Users/luliang/.minikube/machines/minikube/id_rsa&quot;,</span><br><span class="line">          &quot;StorePath&quot;: &quot;/Users/luliang/.minikube&quot;,</span><br><span class="line">          &quot;SwarmMaster&quot;: false,</span><br><span class="line">          &quot;SwarmHost&quot;: &quot;&quot;,</span><br><span class="line">          &quot;SwarmDiscovery&quot;: &quot;&quot;,</span><br><span class="line">          &quot;VBoxManager&quot;: &#123;&#125;,</span><br><span class="line">          &quot;HostInterfaces&quot;: &#123;&#125;,</span><br><span class="line">          &quot;CPU&quot;: 2,</span><br><span class="line">          &quot;Memory&quot;: 4096,</span><br><span class="line"></span><br><span class="line">➜ kubectl edit deploy -n istio-system istio-pilot</span><br><span class="line">deployment.extensions/istio-pilot edited</span><br><span class="line"></span><br><span class="line">## Fixed. All of istio components are running.</span><br><span class="line">➜ kubectl get po -n istio-system</span><br><span class="line">NAME                                      READY   STATUS      RESTARTS   AGE</span><br><span class="line">istio-citadel-78f695c895-bgm9c            1/1     Running     4          23h</span><br><span class="line">istio-egressgateway-5dddcd6df7-f5shm      1/1     Running     4          23h</span><br><span class="line">istio-galley-85fff4bf65-hd7l2             1/1     Running     4          23h</span><br><span class="line">istio-ingressgateway-6d5bc988d7-gmvg2     1/1     Running     4          23h</span><br><span class="line">istio-pilot-6c4d876b55-74z7m              2/2     Running     0          10m</span><br><span class="line">istio-policy-59df9cf56f-vbznd             2/2     Running     25         23h</span><br><span class="line">istio-security-post-install-pkrtj         0/1     Completed   0          23h</span><br><span class="line">istio-sidecar-injector-5695fdf5b7-lgdbn   1/1     Running     21         23h</span><br><span class="line">istio-telemetry-7d567f4998-7btv8          2/2     Running     37         23h</span><br><span class="line">prometheus-7fcd5846db-8t9v2               1/1     Running     18         23h</span><br><span class="line"></span><br><span class="line">## check proxy-stauts</span><br><span class="line">➜  kube istioctl proxy-status</span><br><span class="line">Warning! error execing into istio-pilot-6c4d876b55-74z7m/istio-system discovery container: gc 1 @0.247s 2%: 0.15+27+2.0 ms clock, 0.30+0.047/9.5/15+4.0 ms cpu, 4-&gt;4-&gt;2 MB, 5 MB goal, 2 P</span><br><span class="line">gc 2 @0.294s 3%: 0.016+13+3.0 ms clock, 0.032+0.71/0.24/12+6.1 ms cpu, 4-&gt;4-&gt;3 MB, 5 MB goal, 2 P</span><br><span class="line"></span><br><span class="line">PROXY                                                  CDS        LDS        EDS               RDS          PILOT                            VERSION</span><br><span class="line">istio-egressgateway-5dddcd6df7-f5shm.istio-system      SYNCED     SYNCED     SYNCED (100%)     NOT SENT     istio-pilot-6c4d876b55-74z7m     1.1.0</span><br><span class="line">istio-ingressgateway-6d5bc988d7-gmvg2.istio-system     SYNCED     SYNCED     SYNCED (100%)     NOT SENT     istio-pilot-6c4d876b55-74z7m     1.1.0</span><br></pre></td></tr></table></figure>
<p>There are some addons in istio. You can install and use them directly.</p>
<ul>
<li><p>prometheus<br>kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=prometheus -o jsonpath=’{.items[0].metadata.name}’) 9090:9090<br><a href="http://localhost:9090" target="_blank" rel="noopener">http://localhost:9090</a></p>
</li>
<li><p>grafana<br>kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=grafana -o jsonpath=’{.items[0].metadata.name}’) 3000:3000<br><a href="http://localhost:3000" target="_blank" rel="noopener">http://localhost:3000</a></p>
</li>
<li><p>zipkin<br>kubectl port-forward -n istio-system $(kubectl get pod -n istio-system -l app=zipkin -o jsonpath=’{.items[0].metadata.name}’) 9411:9411<br><a href="http://localhost:9411" target="_blank" rel="noopener">http://localhost:9411</a></p>
</li>
<li><p>servicegraph<br>kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=servicegraph -o jsonpath=’{.items[0].metadata.name}’) 8088:8088<br><a href="http://localhost:8088/force/forcegraph.html" target="_blank" rel="noopener">http://localhost:8088/force/forcegraph.html</a><br><a href="http://localhost:8088/dotviz" target="_blank" rel="noopener">http://localhost:8088/dotviz</a><br><a href="http://localhost:8088/dotgraph" target="_blank" rel="noopener">http://localhost:8088/dotgraph</a></p>
</li>
</ul>
<ol start="3">
<li>Play with istio samples.</li>
</ol>
<ul>
<li>get ingressgetaway connection info.<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export GATEWAY_URL=$(kubectl get po -l istio=ingressgateway -n istio-system -o &apos;jsonpath=&#123;.items[0].status.hostIP&#125;&apos;):$(kubectl get svc istio-ingressgateway -n istio-system -o&apos;jsonpath=&#123;.spec.ports[0].nodePort&#125;&apos;)</span><br><span class="line"></span><br><span class="line">## Since we installed metallb, you also can get it with svc info.</span><br><span class="line">export GATEWAY_URL=192.168.99.201:80</span><br><span class="line"></span><br><span class="line">kubectl get svc -n istio-system</span><br><span class="line">NAME                     TYPE           CLUSTER-IP       EXTERNAL-IP      PORT(S)                                                                                                      AGE</span><br><span class="line">istio-citadel            ClusterIP      10.108.166.71    &lt;none&gt;           8060/TCP,9093/TCP                                                                                            1d</span><br><span class="line">istio-egressgateway      ClusterIP      10.96.223.142    &lt;none&gt;           80/TCP,443/TCP                                                                                               1d</span><br><span class="line">istio-galley             ClusterIP      10.102.157.176   &lt;none&gt;           443/TCP,9093/TCP,9901/TCP                                                                                    1d</span><br><span class="line">istio-ingressgateway     LoadBalancer   10.96.187.129    192.168.99.201   80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:31130/TCP,15030:30515/TCP,15031:30093/TCP,15032:30006/TCP   1d</span><br><span class="line">istio-pilot              ClusterIP      10.101.2.251     &lt;none&gt;           15010/TCP,15011/TCP,8080/TCP,9093/TCP                                                                        1d</span><br><span class="line">istio-policy             ClusterIP      10.103.126.65    &lt;none&gt;           9091/TCP,15004/TCP,9093/TCP                                                                                  1d</span><br><span class="line">istio-sidecar-injector   ClusterIP      10.102.18.170    &lt;none&gt;           443/TCP                                                                                                      1d</span><br><span class="line">istio-telemetry          ClusterIP      10.103.164.99    &lt;none&gt;           9091/TCP,15004/TCP,9093/TCP,42422/TCP                                                                        1d</span><br><span class="line">prometheus               ClusterIP      10.109.103.184   &lt;none&gt;           9090/TCP                                                                                                     1d</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>There are two ways to inject istio-proxy into your applicaton pods. The first method is that we can enable isito-injection for namespace so that all applications will be injected proxy automatically in this namespace. The second is to use istioctl manually to modify pod definition file before installing it.</p>
<ul>
<li><p>enable isito-injection for namespace <strong>default</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; kubectl label namespace default istio-injection=enabled</span><br></pre></td></tr></table></figure>
</li>
<li><p>enable isito-injection by istioctl manually.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">➜ kubectl apply -f &lt;(istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml)</span><br><span class="line">service/details created</span><br><span class="line">deployment.extensions/details-v1 created</span><br><span class="line">service/ratings created</span><br><span class="line">deployment.extensions/ratings-v1 created</span><br><span class="line">service/reviews created</span><br><span class="line">deployment.extensions/reviews-v1 created</span><br><span class="line">deployment.extensions/reviews-v2 created</span><br><span class="line">deployment.extensions/reviews-v3 created</span><br><span class="line">service/productpage created</span><br><span class="line">deployment.extensions/productpage-v1 created</span><br><span class="line"></span><br><span class="line">➜ kubectl get svc</span><br><span class="line">NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">details       ClusterIP   10.96.224.7      &lt;none&gt;        9080/TCP   1m</span><br><span class="line">kubernetes    ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP    1d</span><br><span class="line">productpage   ClusterIP   10.105.194.137   &lt;none&gt;        9080/TCP   1m</span><br><span class="line">ratings       ClusterIP   10.105.57.93     &lt;none&gt;        9080/TCP   1m</span><br><span class="line">reviews       ClusterIP   10.97.20.103     &lt;none&gt;        9080/TCP   1m</span><br><span class="line"></span><br><span class="line">➜ kubectl get deployment</span><br><span class="line">NAME                                DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">details-v1                          1         0         0            0           1m</span><br><span class="line">intent-wallaby-metallb-controller   1         1         1            1           1d</span><br><span class="line">productpage-v1                      1         0         0            0           1m</span><br><span class="line">ratings-v1                          1         0         0            0           1m</span><br><span class="line">reviews-v1                          1         0         0            0           1m</span><br><span class="line">reviews-v2                          1         0         0            0           1m</span><br><span class="line">reviews-v3                          1         0         0            0           1m</span><br></pre></td></tr></table></figure>
</li>
<li><p>test samples app with curl</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; export GATEWAY_URL=$(kubectl get po -l istio=ingressgateway -n istio-system -o &apos;jsonpath=&#123;.items[0].status.hostIP&#125;&apos;):$(kubectl get svc istio-ingressgateway -n istio-system -o &apos;jsonpath=&#123;.spec.ports[0].nodePort&#125;&apos;)</span><br><span class="line"></span><br><span class="line">And test with curl:</span><br><span class="line">&gt; curl -o /dev/null -s -w &quot;%&#123;http_code&#125;n&quot; http://$&#123;GATEWAY_URL&#125;/productpage</span><br><span class="line">200</span><br><span class="line"></span><br><span class="line">With browser, we can go to URL:  http://192.168.99.100:9080/productpage</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ol start="4">
<li>Delete istio<br>We can delete istio by helm if it’s installed by helm. Otherwise, you have to delete it by yourself.<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">helm delete --purge istio</span><br><span class="line"></span><br><span class="line"># if there are something left in kubernetes, you can delete the namespace and pod of istio-system to clean up for istio.</span><br><span class="line"></span><br><span class="line">kubectl delete ns istio-system</span><br><span class="line"></span><br><span class="line">kubectl delete po PODAME --force --grace-period=0</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="Refer-to"><a href="#Refer-to" class="headerlink" title="Refer to:"></a>Refer to:</h2><ul>
<li><a href="https://developer.apple.com/library/archive/technotes/tn2459/_index.html" target="_blank" rel="noopener">https://developer.apple.com/library/archive/technotes/tn2459/_index.html</a></li>
<li><a href="https://github.com/kubernetes/minikube/blob/v0.30.0/README.md" target="_blank" rel="noopener">https://github.com/kubernetes/minikube/blob/v0.30.0/README.md</a></li>
<li><a href="https://stackoverflow.com/questions/52300055/error-restarting-cluster-restarting-kube-proxy-waiting-for-kube-proxy-to-be-up" target="_blank" rel="noopener">https://stackoverflow.com/questions/52300055/error-restarting-cluster-restarting-kube-proxy-waiting-for-kube-proxy-to-be-up</a></li>
<li><a href="https://docs.helm.sh/using_helm/" target="_blank" rel="noopener">https://docs.helm.sh/using_helm/</a></li>
<li><a href="https://preliminary.istio.io/docs/setup/kubernetes/helm-install.html" target="_blank" rel="noopener">https://preliminary.istio.io/docs/setup/kubernetes/helm-install.html</a></li>
<li><a href="https://www.kubernetes.org.cn/3879.html" target="_blank" rel="noopener">https://www.kubernetes.org.cn/3879.html</a></li>
<li><a href="https://metallb.universe.tf/installation/" target="_blank" rel="noopener">https://metallb.universe.tf/installation/</a></li>
<li><a href="https://metallb.universe.tf/tutorial/minikube/" target="_blank" rel="noopener">https://metallb.universe.tf/tutorial/minikube/</a></li>
<li><a href="https://github.com/kubernetes/minikube/blob/master/docs/drivers.md" target="_blank" rel="noopener">https://github.com/kubernetes/minikube/blob/master/docs/drivers.md</a></li>
</ul>

                <hr>
                

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2018/11/17/Explore-go-runtime-engine/" data-toggle="tooltip" data-placement="top"
                           title="Explore go runtime engine">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2018/10/17/git-jenkins/" data-toggle="tooltip" data-placement="top"
                           title="git与jenkins的集成">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                

                


                <!--加入新的评论系统-->
                

                

            </div>

            <div class="hidden-xs col-sm-3 toc-col">
                <div class="toc-wrap">
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#virtual-environment"><span class="toc-text">virtual environment</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#minikube"><span class="toc-text">minikube</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Helm"><span class="toc-text">Helm</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Metallb"><span class="toc-text">Metallb</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#install-Metallb-with-helm"><span class="toc-text">install Metallb with helm.</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#install-Metallb-without-helm"><span class="toc-text">install Metallb without helm</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Istio"><span class="toc-text">Istio</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Refer-to"><span class="toc-text">Refer to:</span></a></li></ol>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5 class="text-center">
                        <a href="/tags/">FEATURED TAGS</a>
                    </h5>
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#minikube"
                           title="minikube">minikube</a>
                        
                        <a class="tag" href="/tags/#kubernetes"
                           title="kubernetes">kubernetes</a>
                        
                        <a class="tag" href="/tags/#helm"
                           title="helm">helm</a>
                        
                        <a class="tag" href="/tags/#Istio"
                           title="Istio">Istio</a>
                        
                        <a class="tag" href="/tags/#Metallb"
                           title="Metallb">Metallb</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>
        </div>

    </div>
</article>







<!-- Footer -->
<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <br>
                <ul class="list-inline text-center">
                
                
                    <li>
                        <a target="_blank" href="https://twitter.com/lu-liang">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/lu.ll.liang">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/lu-liang">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="https://www.facebook.com/lu-liang">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank"  href="https://github.com/lu-liang">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank"  href="https://www.linkedin.com/in/lu.ll.liang">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; 亮随笔 2019
                    <br>
                </p>

            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="../../../../js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="../../../../js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="../../../../js/blog.js"></script>

<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://lu-liang.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>

<!-- Google Analytics -->



<!-- Baidu Tongji -->


<!-- swiftype -->
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','','2.0.0');
</script>

<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!--wechat title img-->
<img class="wechat-title-img" src=""><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>

</html>
